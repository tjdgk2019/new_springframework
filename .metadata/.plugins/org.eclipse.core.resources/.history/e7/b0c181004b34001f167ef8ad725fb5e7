package com.kh.spring.board.controller;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpSession;

import org.apache.ibatis.session.RowBounds;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.multipart.MultipartFile;
import org.springframework.web.servlet.ModelAndView;

import com.kh.spring.board.model.service.BoardService;
import com.kh.spring.board.model.vo.Board;
import com.kh.spring.common.model.vo.PageInfo;
import com.kh.spring.common.template.PageTemplate;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Controller
@RequiredArgsConstructor
@Slf4j
public class BoardController {

	private final BoardService boardService;
	/*
	private int abc = 0;
	public BoardService getBoardService() {
		return boardService;
	}
	public int getAbc() {
		return abc;
	}
	public BoardService getBoardServiceAndAbc() {
		return boardService + abc;
	}
	*/
	// member.jspì—ì„œ í´ë¦­ ì‹œ = boardlist
	// í˜ì´ì§•ë°”ë¥¼ í´ë¦­í–ˆë‹¤ !! => boardlist?page=ìš”ì²­í˜ì´ì§€
	
	// localhost/spring/boardlist
	// localhost/spring/boardlist?page=2
	// localhost/spring/boardlist?page=3
	@GetMapping("boardlist")
	public String forwarding(@RequestParam(value="page",defaultValue = "1")int page,
								Model model) {
		
		// --í˜ì´ì§• ì²˜ë¦¬--
		
		// í•„ìš”í•œ ë³€ìˆ˜ë“¤
		int listCount; //í˜„ì¬ ì¼ë°˜ ê²Œì‹œíŒì˜ ê²Œì‹œê¸€ ì´ ê°œìˆ˜ => Boardí…Œì´ë¸”ë¡œë¶€í„° SELECT COUNT(*)í™œìš©í•´ì„œ ì¡°íšŒ
		int currentPage;  // í˜„ì¬ í˜ì´ì§€(ì‚¬ìš©ìê°€ ìš”ì²­í•œ í˜ì´ì§€) => ì•ì—ì„œ ë„˜ê¸¸ ê²ƒ
		int pageLimit; // í˜ì´ì§• í•˜ë‹¨ì— ë³´ì—¬ì§ˆ í˜ì´ì§•ë°”ì˜ ìµœëŒ€ ê°œìˆ˜ => 10ê°œ
		int boardLimit; // í•œ í˜ì´ì§€ì— ë³´ì—¬ì§ˆ ê²Œì‹œê¸€ì˜ ìµœëŒ€ ê°œìˆ˜ => 10ê°œ
		
		
		int maxPage;  // ê°€ì¥ ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ëª‡ ë²ˆ í˜ì´ì§€ì¸ì§€(ì´ í˜ì´ì§€ ê°œìˆ˜)
		int startPage; // í˜ì´ì§€ í•˜ë‹¨ì— ë³´ì—¬ì§ˆ í˜ì´ì§•ë°”ì˜ ì‹œì‘ ìˆ˜
		int endPage; // í˜ì´ì§€ í•˜ë‹¨ì— ë³´ì—¬ì§ˆ í˜ì´ì§•ë°”ì˜ ë ìˆ˜
		
		//ã…£ * listCount : ì´ ê²Œì‹œê¸€ì˜ ìˆ˜
		listCount = boardService.boardCount();
		
		// currnetPage : í˜„ì¬ í˜ì´ì§€(ì‚¬ìš©ìê°€ ìš”ì²­í•œ í˜ì´ì§€)
		currentPage = page;
		log.info("ê²Œì‹œê¸€ì˜ ì´ ê°œìˆ˜ : {}, í˜„ì¬ ìš”ì²­ í˜ì´ì§€ : {}",listCount,currentPage );
		
		// * pageLimit : í˜ì´ì§•ë°”ì˜ ìµœëŒ€ ê°œìˆ˜
		pageLimit = 10;
		
		// * boardLimit : í•œ í˜ì´ì§€ì— ë³´ì—¬ì§ˆ ê²Œì‹œê¸€ì˜ ìµœëŒ€ ê°œìˆ˜
		boardLimit = 10;
		
		// * maxPage : ê°€ì¥ ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ëª‡ ë²ˆ í˜ì´ì§€ì¸ì§€(ì´ í˜ì´ì§€ ê°œìˆ˜)
		/*
		 * listCount, boardLimitì— ì˜í–¥ì„ ë°›ìŒ
		 * 
		 * - ê³µì‹ êµ¬í•˜ê¸°
		 * 	ë‹¨, boardLimitì´ 10ì´ë¼ëŠ” ê°€ì •í•˜ì— ê·œì¹™ì„ ì°¾ì•„ë³´ì
		 * 
		 * ì´ ê°œìˆ˜ (listCount)			ê²Œì‹œê¸€ ê°œìˆ˜(boardLimit)		maxPage(ë§ˆì§€ë§‰í˜ì´ì§€)
		 * 100						10					==		10í˜ì´ì§€
		 * 106						10					==		11í˜ì´ì§€
		 * 111						10					==		12í˜ì´ì§€
		 * => ë‚˜ëˆ„ì…ˆ ê²°ê³¼ì— ì†Œìˆ˜ì ì„ ë¶™ì—¬ì„œ ì˜¬ë¦¼ì²˜ë¦¬ë¥¼ í•  ê²½ìš° maxPageê°€ ë¨
		 *
		 * listCount/boardLimit
		 * 
		 * ìŠ¤í…
		 * 1. listCountë¥¼ doubleë¡œ ë³€í™˜
		 * 2. listCount / boardLimit
		 * 3. Math.ceil() => ê²°ê³¼ë¥¼ ì˜¬ë¦¼ì²˜ë¦¬ 
		 * 4. ê²°ê³¼ê°’ì„ intë¡œ í˜•ë³€í™˜
		 */
		
		maxPage = (int)Math.ceil((double)listCount/boardLimit);
		
		//Math math = new Math(); 
		//ì „ë¶€ static 
		// * startPage : í˜ì´ì§€ í•˜ë‹¨ì— ë³´ì—¬ì§ˆ í˜ì´ì§•ë°”ì˜ ì‹œì‘ ìˆ˜
		/*
		 * currentPage, pageLimitì— ì˜í–¥ì„ ë°›ìŒ
		 * 
		 * -ê³µì‹
		 * 		ë‹¨, pageLimitì´ 10ì´ë¼ê³  ê°€ì •
		 * 
		 * - startPage : 1, 11, 21, 31, 41 => n * 10 +1
		 * 
		 * ë§Œì•½ì— pageLmitì´ 5ë‹¤
		 * - startPage : 1, 6, 11, 16, 21 => n * 5 +1
		 * \
		 * ì¦‰ , startPage = n * pageLimit + 1
		 * 
		 * currentPgae		startPage
		 * 1					1
		 * 5					1
		 * 9					1
		 * 10					1
		 * 13					11
		 * 15					11
		 * 20					11
		 * 21					21

		 * => 1~10 : n * 10 +1 ==> n ==0
		 * => 11~20 : n * 10+1 ==> n ==1
		 * => 21~30 : n * 10+1 ==> n ==2
		 *
		 *1 ~ 10 /10 => 0 ~ 1
		 *11~ 20 /10 => 1 ~ 2
		 *21 ~ 30 /10 => 2 ~3
		 *
		 *  n = (currentPage -1) / pageLimit;
		 *
		 *  startPage = (currentPage -1 )/ pageLimit * pageLimit +1 ;
		 */
		
		startPage = (currentPage -1 )/ pageLimit * pageLimit +1 ;
		
		// * endPage : í˜ì´ì§€ í•˜ë‹¨ì— ë³´ì—¬ì§ˆ í˜ì´ì§• ë°”ì˜ ë ìˆ˜
		/*
		 * startPage, pageLimitì— ì˜í–¥ì„ ë°›ìŒ(maxPageë„ ë§ˆì§€ë§‰ í˜ì´ì§•ë°”ì— ëŒ€í•´ ì˜í–¥ì„ ë¼ì¹¨)
		 * -ê³µì‹
		 * ë‹¨ , pageLimitì´ 10ì´ë¼ê³  ê°€ì •í•˜ê³ 
		 * 
		 * startPage 1 => endPage : 10
		 * startPage : 11 => endPage : 20
		 * startPage : 21 => endPage : 30
		 *	endPage = startPage + pageLimit -1; 
		 */
		
		// startPageê°€ 1ì´ë¼ì„œ endPageê°€ 10ì´ ë“¤ì–´ê°”ëŠ”ë°
		// maxPageê°€ 2ë‹¤
		// endPageë¥¼ maxPageê°’ì„ ë³€ê²½í•´ì•¼í•œë‹¤.
		//
		
		endPage = startPage + pageLimit -1;
		if(endPage > maxPage) endPage = maxPage;
		
		// ì•„ ë–»ê²Œ í•˜ì§€?? xxx
		// ì•„ ë­ì“°ì§€?? 000
		// ìã…ã…‚ì—ì„œ ë‚´ê°€ ë‹¤ë¤„ì•¼í•  ê°’ì´ ë§ë‹¤.
		// ì„ íƒì§€ê°€ ì—†ë‹¤.
		//1ë²ˆ í´ë˜ìŠ¤/2ë²ˆ int[]/3ë²ˆ List/4ë²ˆ Map/
		
		//1ë²ˆ í´ë˜ìŠ¤
		//PageInfo pageInfo = new PageInfo(listCount, currentPage, pageLimit, boardLimit, maxPage, startPage, endPage);
		//ìš°ë¦¬ íŒ€ì€ í˜ì´ì§• ì²˜ë¦¬í• ë•Œ ìƒìƒ‰ì¢€ ë‚´ë„ ê´œì¶¤
		//í•„ë“œê°€ ë§ìœ¼ë©´ ì–´ë–¤ ìˆœì„œë¡œ ë„£ì–´ì•¼í•˜ëŠ”ì§€ëª¨ë¦„
		
		//2ë²ˆ í´ë˜ìŠ¤ @Builder ê°ì²´ : ë„£ê³  ì‹¶ì€ í•„ë“œì˜ ê°’ë§Œ ë„£ì„ ìˆ˜ ìˆë”°. ë§¤ì„œë“¤ë¥´ ê³„ì† ì“¸ì‘¤ìˆë„ë¡, ìˆœì„œì— êµ¬í•´ë§ì§€ì•ŠìŒ.
		
		
		 PageInfo pageInfo = PageInfo.builder()
									.listCount(listCount)
									.currentPage(currentPage)
									.pageLimit(pageLimit)
									.boardLimit(boardLimit)
									.maxPage(maxPage)
									.startPage(startPage)
									.endPage(endPage)
									.build();
	
									/*
		 * boardLimitì´ 10ì´ë¼ëŠ” ê°€ì •í•˜ì—
		 * 
		 * currentPage == 1 => ì‹œì‘ê°’ì€ 1,  ëê°’ 10
		 * currentPage == 2 => ì‹œì‘ê°’ì€ 11, ëê°’ 20
		 * currentPage == 3 => ì‹œì‘ê°’ì€ 21, ëê°’ 30
		 * 
		 * ì‹œì‘ê°’ = currentPage * boardLimit -9
		 * ì‹œì‘ê°’ = (currentPage - 1) * boardLimit + 1
		 * ë ê°’ = ì‹œì‘ê°’ + boardLimit -1
		 */
		Map<String, Integer> map = new HashMap();
		
		int startValue = (currentPage -1) * boardLimit +1;
		int endValue = startValue + boardLimit -1;
		
		map.put("startValue", startValue);
		map.put("endValue", endValue);
		
		List<Board> boardList = boardService.findAll(map);
		
		log.info("ì¡°íšŒëœ ê²Œì‹œê¸€ì˜ ê°œìˆ˜ : {}", boardList.size());
		log.info("--------------------------------");
		log.info("ì¡°íšŒëœ ê²Œì‹œê¸€ ëª©ë¡ : {}", boardList);
		
		model.addAttribute("list",boardList);
		model.addAttribute("pageInfo",pageInfo);
		
		
		return "board/list";
	}
	
	
	@GetMapping("search.do")
	public String search(String condition, String keyword,
					@RequestParam(value = "page", defaultValue = "1")int page,Model model) {
		
		log.info("ê²€ìƒ‰ì¡°ê±´ : {} ", condition);
		log.info("ê²€ìƒ‰ í‚¤ì›Œë“œ : {} ", keyword);
		// ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¡°ê±´ê³¼ ì…ë ¥í•œ í‚¤ì›Œë“œë¥¼ ê°€ì§€ê³ 
		// í˜ì´ì§• ì²˜ë¦¬ë¥¼ ëë‚¸ í›„ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ë“¤ê³ ê°€ì•¼í•¨
		
		// condition ì— ë“¤ì–´ì˜¤ëŠ” ê°’ writer, title, content
		// keyword ì— ë“¤ì–´ì˜¤ëŠ” ê°’ ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‚¤ì›Œë“œ->ëª¨ê°€ ë“¤ì–´ì˜¤ëŠ”ì§€ ì•Œ ìˆ˜ ì—†ë‹¤.
		
		// String[], List, Set, Map, Class ì¤‘ íƒ 1
		Map<String, String> map = new HashMap();
		map.put("condition", condition);
		map.put("keyword", keyword);
		
		int searchCount = boardService.searchCount(map);
		log.info("ê²€ìƒ‰ ì¡°ê±´ì— ë¶€í•©í•˜ëŠ” í–‰ì˜ ìˆ˜ : {}", searchCount);
		
		int currentPage = page;
		int pageLimit = 3;
		int boardLimit = 3;
		/*
		int maxPage = (int)Math.ceil((double)searchCount/boardLimit);
		int startPage = (currentPage-1)/pageLimit * pageLimit +1;
		int endPage = startPage + pageLimit -1;
		if(endPage>maxPage) endPage = maxPage;
		
		PageInfo pageInfo = PageInfo.builder()
									.pageLimit(pageLimit)
									.startPage(startPage)
									.endPage(endPage)
									.listCount(searchCount)
									.currentPage(currentPage)
									.maxPage(maxPage)
									.boardLimit(boardLimit)
									.build();
		*/
		
		PageInfo pageInfo = PageTemplate.getPageInfo(searchCount, currentPage, pageLimit, boardLimit);
		
		
		// ë§ˆì´ë°”í‹°ìŠ¤ì—ì„œ ì œê³µí•˜ëŠ” RowBounds
		// offset : ì „ì²´ ì¡°íšŒ ê²°ê³¼ì—ì„œ ëª‡, limit : í•œë²ˆ ì¡°íšŒ ê²°ê³¼ì—ì„œ ëª‡ê°œ ë“¤ê³ ê°ˆì§€
		RowBounds rowBouds = new RowBounds((currentPage -1) * boardLimit,boardLimit);
		//ã…MyBatisì—ì„œëŠ” í˜ì´ì§• ì²˜ë¦¬ë¥´ ã„¹ìœ„í•´ RowBoudsë¼ëŠ” í´ë˜ìŠ¤ë¥¼ ì œê³µ
		// offset, limit
		/*
		 * boardLimitì´ 3ì¼ ê²½ìš° 		ê±´ë„ˆë›¸ ìˆ«ì(offset)
		 * 
		 * currentPage : 1 -> 1~3 ==> 0
		 * currentPage : 2 -> 4~6 ==> 3
		 * currentPage : 3 -> 7~9 ==> 6
		 * 
		 * (currentPgae() -1) * boardLmit()
		 * 
		 */
		List<Board> boardList = boardService.findByConditionAndKeyword(map, rowBouds);
		
		model.addAttribute("list",boardList);
		model.addAttribute("pageInfo",pageInfo);
		model.addAttribute("keyword",keyword);
		model.addAttribute("condition",condition);
		
		
		return "board/list";
	}
	
	@GetMapping("insertForm.do")
	public String boardForwarding() {
		return "board/insertForm";
	}
	
	@PostMapping("insert.do")
	public String insert(Board board, MultipartFile upfile ,HttpSession session ,Model model) {
						
	    log.info("ê²Œì‹œê¸€ì •ë³´ : {}", board);
	    log.info("íŒŒì¼ì˜ì •ë³´ : {}", upfile);
	    
	    if(!upfile.getOriginalFilename().equals("")) {
	         /*
	         //uploadFiles ë””ë ‰í† ë¦¬ì— íŒŒì¼ ì—…ë¡œë“œ
	         //ì´ë¦„ ë³€ê²½ :  KH_ë…„ì›”ì¼ì‹œë¶„ì´ˆ_ëœë¤ê°’.í™•ì¥ì
	         String originName = upfile.getOriginalFilename();
	         String ext = originName.substring(originName.lastIndexOf("."));
	         //ëœë¤ê°’
	         //Math.random(); >> 0.0 ~ 0.999999999999 ì˜ ê°’
	         int num = (int) (Math.random() * 900) + 100; // 100 ìœ„ì¹˜ : ë²”ìœ„, 1 ìœ„ì¹˜ : ì‹œì‘ê°’
	         //ë…„ì›”ì¼ì‹œë¶„ì´ˆ 
	         String currentTime = new SimpleDateFormat("yyyyMMddHHmmss").format(new Date());
	         //ì—…ë¡œë“œ ê²½ë¡œ : í”„ë¡œê·¸ë¨ ì „ì—­ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” Application ê°ì²´ë¥¼ ì‚¬ìš©
	         String savePath = session.getServletContext().getRealPath("/resources/uploadFiles/");   
	         
	         String changeName = "KH_" + currentTime + "_" + num + ext;
	         
	         //íŒŒì¼ ì—…ë¡œë“œ
	         try {
	            upfile.transferTo(new File(savePath + changeName));
	         } catch (IllegalStateException e) {
	            e.printStackTrace();
	         } catch (IOException e) {
	            e.printStackTrace();
	         }*/
	         
	         
	         
	         //Board ê°ì²´ì— originName + changeName ê°’ ì €ì¥ (ì²¨ë¶€íŒŒì¼ì´ ì¡´ì¬í•œë‹¤ëŠ” ì¡°ê±´ì¼ ê²½ìš°ì˜ ì½”ë“œì´ë¯€ë¡œ ê°’ ì§€ì •í•´ì¤˜ì•¼ í•¨!)
	         board.setOriginName(upfile.getOriginalFilename());
	         board.setChangeName(saveFile(upfile, session));
	      } 
	    //ì²¨ë¶€íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš° board : ì œëª© ë‚´ìš© ì‘ì„±ì
	    // ì²¨ë¶€íŒŒì¼ì´ ì¡´ì¬í•  ê²½ìš° board : ì œëª© ë‚´ìš© ì‘ì„±ì ì›ë³¸ëª… ë³€ê²½ë˜ ê²½ë¡œì™€ ì´ë¦„
	    
	    if(boardService.insert(board)>0) {
	    	session.setAttribute("alertMsg","ê²Œì‹œë¬¼ë“±ë¡ì™„ë£Œ");
	    	
	    	//ë¬´ì¡°ê±´ ë¦¬ë‹¤ì´ë ‰íŠ¸í•´ì•¼í•¨
	    	
	    	return "redirect:boardlist";
	    }else {
	    	model.addAttribute("alertMsg","ê²Œì‹œë¬¼ë“±ë¡ì‹¤íŒ¨ë‹¤ 18");
	    }

	    return "redirect:/insertForm.do";
	}

	
	@GetMapping("board-detail")
		public ModelAndView findByBoardNo(int boardNo,  ModelAndView mv ) {
		//1.ë°ì´í„°ê°€ê³µ : 1ê°œë¼ì„œ í• ê²Œì—†ë„¤ 
		//2.ì„œë¹„ìŠ¤í˜¸ì¶œ : 
		//3.ì‘ë‹µí™”ë©´ì§€ì •
		
		  if (boardService.increaseCount(boardNo) > 0) { // ì„±ê³µ => ë©”ì¸~
			  mv.addObject("board", boardService.findById(boardNo)).setViewName("board/boardDetail");
	        } else { // ì‹¤íŒ¨ => ì—ëŸ¬ë©”ì‹œì§€ë‹´ì•„ì„œ ì—ëŸ¬í˜ì´ì§€ë¡œ í¬ì›Œë”©
	        	mv.addObject("erroMsg","ê²Œì‹œê¸€ ìƒì„¸ì¡°íšŒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤").setViewName("common/errorPage");
	        	
	        }
		
		return mv;
		}
	
	/*
	 * deleteById : Client (ê²Œì‹œê¸€ì¥ì„ì) ì—ê²Œ ì •ìˆ˜í–‰ì˜ boardNO(ë³´ë“œí…Œì´ë¸”ì˜ PK)ë¥¼ ì „ë‹¬ ë°›ì•„ì„œBOARDí…Œì´ë¸”ì˜ ì¡´ì¬í•˜ëŠ” STATUS ì¹¼ëŸ¼ì˜ ê°’ì„ 'N'ìœ¼ë¡œ ìƒì‹ 
	 * 
	 * 
	 * @param boardNO :ê°í–‰ì„ ì‹ë³„í•˜ê¸° ìœ„í•œ PK
	 * @param filePath: ìš”ì²­ì²˜ë¦¬ ì„±ê³µì‹œ ì²¨ë¶€íŒŒì¼ì„ ì œê±°í•˜ê¸° ìœ„í•´ íŒŒì¼ì´ ì €ì¥ë˜ì–´ìˆëŠ” ê²½ë¡œ ë° íŒŒì¼ëª…
	 * @return : ë°˜í™˜ëœ View ë…¼ë¦¬ì ì€ ê²½ë¡œ
	 * 
	 */
	
	@PostMapping("boardDelete.do")
	public String deleteById(int boardNo, String filePath ,Model model,HttpSession session) { 
		
		/*
		 * ì§ˆë¬¸ì˜ êµ¬ì¡°
		 * 
		 * 1ë‚´ê°€ ì§€ê¸ˆ ë¬´ìŠ¨ì¼í•˜ê³ ìˆëŠ”ë°
		 * 
		 * 2ì–´ëŠë¶€ë¶„ì—ì„œ ë¬´ìŠ¨ ë¬¸ì œê°€ ë°œìƒí–ˆëŠ”ì§€ 
		 * 
		 * 3.ì œìƒê°ì—ëŠ” ... ìš”ê±°ë¥¼ ì°¾ì•„ê°€ì§€ê³  ì–´ë–¤ë°©ë²•ìœ¼ë¡œ í•´ê²°ì„ í•´ë³´ë ¤ í–ˆìœ¼ë‚˜,,,
		 * 
		 * 4. ì–´ë–¤ë°©ë²•ì„ ì‚¬ìš©í•˜ë©´ë ê¹Œìš”????????
		 * 
		 * */
	    	if (boardService.delete(boardNo) > 0) {
	    	    if (!"".equals(filePath)) {
	    	        new File(session.getServletContext().getRealPath(filePath)).delete();
	    	    }
	    	    session.setAttribute("alertMsg", "ê²Œì‹œê¸€ ì‚­ì œ ì„±ê³µ ğŸ˜");
	    	    return "redirect:boardlist";
	    	

	    }else {
	    	model.addAttribute("erroMsg","ê²Œì‹œê¸€ ì‚­ì œ ì‹¤íŒ¨!");
	    	return "common/errorPage";
	    }
		
	}
	
	@PostMapping("boardUpdateForm.do")
	public ModelAndView updateForm(ModelAndView mv, int boardNo) {
	    mv.addObject("board", boardService.findById(boardNo))
	      .setViewName("board/boardUpdate");
	    return mv;
	}
	@PostMapping("board-update.do")
	public String update(Board board,MultipartFile reupFile,HttpSession session) {
		
		// DBê°€ì„œ BOARDí…Œì´ë¸” UPDATE

		// Board board
		/*
		 *  -> boardTitle, boardContent
		 *  -> boardWriter, boardNo
		 * 
		 * + File
		 * 1. ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ X, ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ X  => ê·¸ë¬´ëƒ~
		 * 
		 * 2. ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ O, ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ X  => origin : ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ì´ë¦„, change : ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ ê²½ë¡œ
		 * 
		 * 3. ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ X, ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ O  => origin : ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ ì´ë¦„, change : ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ ê²½ë¡œ
		 * 
		 * 4. ê¸°ì¡´ ì²¨ë¶€íŒŒì¼ O, ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ O  => origin : ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ ì´ë¦„, change : ìƒˆë¡œìš´ ì²¨ë¶€íŒŒì¼ ê²½ë¡œ
		 */
		if (!reupFile.getOriginalFilename().equals("")) {
		    board.setOriginName(reupFile.getOriginalFilename());
		    board.setChangeName(saveFile(reupFile, session));
		}

		if (boardService.update(board) > 0) {
		    session.setAttribute("alertMsg", "ê²Œì‹œë¬¼ ìˆ˜ì • ì™„ë£Œ");
		    return "redirect:board-detail?boardNo=" + board.getBoardNo();
		}else {
			 session.setAttribute("alertMsg", "ê²Œì‹œë¬¼ ìˆ˜ì • ì‹¤íŒ¨ë‹¤ ì´ìì‹ì•„");
			 return "common/errorPage";
		}

		
		
	}
	//íŒŒì¼ì—…ë¡œë“œì˜ ë©”ì„œë“œë¥¼ ë§Œë“¤ì–´ì¤Œ 
	public String saveFile(MultipartFile upfile,HttpSession session) {
		  String originName = upfile.getOriginalFilename();
	         String ext = originName.substring(originName.lastIndexOf("."));
	         //ëœë¤ê°’
	         //Math.random(); >> 0.0 ~ 0.999999999999 ì˜ ê°’
	         int num = (int) (Math.random() * 900) + 100; // 100 ìœ„ì¹˜ : ë²”ìœ„, 1 ìœ„ì¹˜ : ì‹œì‘ê°’
	         //ë…„ì›”ì¼ì‹œë¶„ì´ˆ 
	         String currentTime = new SimpleDateFormat("yyyyMMddHHmmss").format(new Date());
	         //ì—…ë¡œë“œ ê²½ë¡œ : í”„ë¡œê·¸ë¨ ì „ì—­ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” Application ê°ì²´ë¥¼ ì‚¬ìš©
	         String savePath = session.getServletContext().getRealPath("/resources/uploadFiles/");   
	         
	         String changeName = "KH_" +currentTime +"_" +num +ext;
	         
	         try {
	                upfile.transferTo(new File(savePath + changeName));
	            } catch (IllegalStateException e) {
	                e.printStackTrace();
	            } catch (IOException e) {
	                e.printStackTrace();
	            }
	    return "resources/uploadFiles/" +changeName;
	}
	
	@GetMapping("image-board")
	public String images(Model model) {
		//List<Board> images = boardService.selectImages();
		model.addAttribute("board", boardService.selectImages());
		
		
		return "board/imageList";
	}
	
	@ResponseBody
	@GetMapping(value="reply", produces="application; charset=UTF-8")
	public String selectReply(int boardNo) {
		boardService.selectReply(boardNo);
		return null;

	}
	
	
}


